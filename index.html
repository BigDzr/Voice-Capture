<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Voice Stream Widget</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent !important;
            color: #ffffff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Beautiful dark modern container - with transparency option */
        .widget-container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 600px;
            width: 100%;
            position: relative;
            backdrop-filter: blur(20px);
        }

        /* Transparent mode for entire widget */
        body.transparent-capture {
            background: transparent !important;
        }

        body.transparent-capture .widget-container {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
            backdrop-filter: none !important;
        }

        body.transparent-capture .title {
            display: none;
        }

        body.transparent-capture .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0.7;
        }

        body.transparent-capture .control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            opacity: 0.7;
        }

        body.transparent-capture .audio-visualizer {
            display: none;
        }

        .title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 300;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Modern control panel */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-panel {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .style-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .style-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .style-btn.active {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border-color: #4ecdc4;
        }

        .style-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .style-btn.active:hover {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-label {
            font-size: 12px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toggle-switch.active {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border-color: #4ecdc4;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }

        .control-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(78, 205, 196, 0.3);
        }

        .start-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stop-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .stop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        /* Modern status display */
        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.listening {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
            animation: pulse 2s infinite;
        }

        .status.idle {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        /* Enhanced status indicator */
        .status-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(170, 170, 170, 0.8);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .status-indicator.listening {
            background: #4ecdc4;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.6);
            animation: pulse 2s infinite;
            border-color: #4ecdc4;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        /* Beautiful visualizer */
        .audio-visualizer {
            width: 100%;
            height: 80px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .visualizer-bars {
            display: flex;
            gap: 3px;
            height: 60px;
            align-items: end;
            justify-content: center;
        }

        .bar {
            width: 4px;
            background: linear-gradient(to top, #4ecdc4, #ff6b6b);
            border-radius: 2px;
            transition: height 0.1s ease;
            min-height: 8px;
            opacity: 0.8;
        }

        .bar:hover {
            opacity: 1;
        }

        /* Add a subtle label */
        .audio-visualizer::before {
            content: "Audio Visualizer";
            position: absolute;
            top: 5px;
            left: 10px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Beautiful modern chat display - with transparent mode */
        .chat-overlay {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .chat-overlay.transparent-mode {
            background: transparent;
            border: none;
            padding: 10px;
        }

        .chat-overlay.transparent-mode .chat-message {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(78, 205, 196, 0.3);
            margin-bottom: 8px;
            max-width: 80%;
        }

        .chat-overlay.transparent-mode .interim-message {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(78, 205, 196, 0.2);
        }

        /* Mega Man 8 Dialogue Style - Text-based styling */
        .chat-overlay.megaman-mode {
            background: transparent;
            border: none;
            padding: 10px;
        }

        .chat-overlay.megaman-mode .audio-visualizer {
            display: none;
        }

        .chat-overlay.megaman-mode .chat-message {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 8px 0px;
            margin-bottom: 8px;
            position: relative;
            font-family: 'Courier New', monospace;
            box-shadow: none;
            max-width: 100%;
            backdrop-filter: none;
            border-left: none;
        }

        .chat-overlay.megaman-mode .message-text {
            font-size: 18px;
            line-height: 1.3;
            color: #60a5fa;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .chat-overlay.megaman-mode .timestamp {
            font-size: 11px;
            color: #93c5fd;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .chat-overlay.megaman-mode .interim-message {
            background: transparent;
            border: none;
            animation: megamanInterimPulse 1s ease-in-out infinite alternate;
        }

        .chat-overlay.megaman-mode .interim-message .message-text {
            color: #10b981;
 
        }


        .chat-overlay.megaman-mode .interim-message .timestamp {
            color: #6ee7b7;
        }

        @keyframes megamanInterimPulse {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .chat-overlay.megaman-mode .empty-state {
            background: transparent;
            border: none;
            color: #60a5fa;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 
                0 0 5px rgba(96, 165, 250, 0.8),
                0 0 10px rgba(96, 165, 250, 0.6),
                2px 2px 0px #1e40af,
                -1px -1px 0px #1e40af,
                1px -1px 0px #1e40af,
                -1px 1px 0px #1e40af;
            padding: 40px 20px;
            border-radius: 0;
            box-shadow: none;
            font-weight: 700;
            font-size: 14px;
        }

        /* Hide visualizer in Mega Man mode */
        .widget-container.megaman-mode .audio-visualizer {
            display: none;
        }

        /* Body background for Mega Man mode */
        body.megaman-mode {
            background: transparent;
        }

        .widget-container.megaman-mode {
            background: transparent;
            border: none;
            box-shadow: none;
            backdrop-filter: none;
        }

        .chat-message {
            background: rgba(78, 205, 196, 0.2);
            backdrop-filter: blur(10px);
            padding: 12px 18px;
            border-radius: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4ecdc4;
            animation: slideInFade 0.5s ease;
            max-width: 100%;
            word-wrap: break-word;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        @keyframes slideInFade {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
            color: #ffffff;
        }

        .timestamp {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .chat-message.interim-message {
            background: rgba(78, 205, 196, 0.1);
            border-left-color: rgba(78, 205, 196, 0.5);
            opacity: 0.8;
            font-style: italic;
        }

        .chat-message.interim-message .message-text {
            color: rgba(255, 255, 255, 0.8);
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 60px 20px;
        }

        /* Auto-fade old messages */
        .chat-message.fade-out {
            animation: fadeOut 1s ease forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        .error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        /* Responsive design for different OBS scene sizes */
        @media (max-width: 600px) {
            .widget-container {
                padding: 20px;
                max-width: 100%;
            }
            
            .audio-visualizer {
                height: 50px;
            }
            
            .chat-overlay {
                height: 250px;
            }
            
            .chat-message {
                font-size: 12px;
                padding: 10px 15px;
            }
            
            .control-btn {
                padding: 12px 24px;
                font-size: 14px;
            }
        }

        /* Custom scrollbar for chat - hidden but functional */
        .chat-overlay::-webkit-scrollbar {
            display: none;
        }

        .chat-overlay {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <h1 class="title">Voice Stream Widget</h1>
        
        <div class="controls">
            <button id="startBtn" class="control-btn start-btn">Start Listening</button>
            <button id="stopBtn" class="control-btn stop-btn" disabled>Stop</button>
        </div>

        <div class="control-panel">
            <div class="style-selector">
                <button id="solidBtn" class="style-btn active">Solid</button>
                <button id="transparentBtn" class="style-btn">Transparent</button>
                <button id="megamanBtn" class="style-btn">Mega Man</button>
                <button id="captureBtn" class="style-btn">Capture</button>
            </div>
        </div>

        <div id="statusIndicator" class="status-indicator"></div>
        <div id="error" class="error" style="display: none;"></div>

        <div class="audio-visualizer">
            <div class="visualizer-bars" id="visualizer"></div>
        </div>

        <div class="chat-overlay" id="chatOverlay">
            <div class="empty-state">Your transcribed messages will appear here...</div>
        </div>
    </div>

    <script>
        class OBSVoiceWidget {
            constructor() {
                this.recognition = null;
                this.audioContext = null;
                this.microphone = null;
                this.analyser = null;
                this.dataArray = null;
                this.isListening = false;
                this.staticSource = null;
                this.messageQueue = [];
                this.maxMessages = 5; // Limit messages for performance
                
                this.initElements();
                this.initVisualizer();
                this.setupEventListeners();
                this.checkBrowserSupport();
                this.optimizeForOBS();
            }

            initElements() {
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.error = document.getElementById('error');
                this.chatOverlay = document.getElementById('chatOverlay');
                this.visualizer = document.getElementById('visualizer');
                this.widgetContainer = document.querySelector('.widget-container');
                
                // Style buttons
                this.solidBtn = document.getElementById('solidBtn');
                this.transparentBtn = document.getElementById('transparentBtn');
                this.megamanBtn = document.getElementById('megamanBtn');
                this.captureBtn = document.getElementById('captureBtn');
                
                this.currentStyle = 'solid';
            }

            initVisualizer() {
                // Create more prominent bars
                for (let i = 0; i < 40; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = '8px';
                    this.visualizer.appendChild(bar);
                }
                this.bars = this.visualizer.querySelectorAll('.bar');
            }

            optimizeForOBS() {
                // Reduce animation frequency for better performance
                this.animationFrame = null;
                this.lastAnimationTime = 0;
                this.animationInterval = 1000 / 30; // 30 FPS instead of 60

                // Auto-clear old messages to prevent memory buildup
                setInterval(() => {
                    this.cleanupOldMessages();
                }, 15000); // Clean up every 15 seconds
            }

            setupEventListeners() {
                this.startBtn.addEventListener('click', () => this.startListening());
                this.stopBtn.addEventListener('click', () => this.stopListening());
                
                // Style button functionality
                this.solidBtn.addEventListener('click', () => this.setStyle('solid'));
                this.transparentBtn.addEventListener('click', () => this.setStyle('transparent'));
                this.megamanBtn.addEventListener('click', () => this.setStyle('megaman'));
                this.captureBtn.addEventListener('click', () => this.setStyle('capture'));
                
                // Auto-start for OBS convenience (optional)
                document.addEventListener('keydown', (e) => {
                    if (e.key === ' ' && e.ctrlKey) {
                        e.preventDefault();
                        if (this.isListening) {
                            this.stopListening();
                        } else {
                            this.startListening();
                        }
                    }
                    
                    // Style shortcuts
                    if (e.key === '1') this.setStyle('solid');
                    if (e.key === '2') this.setStyle('transparent');
                    if (e.key === '3') this.setStyle('megaman');
                    if (e.key === '4') this.setStyle('capture');
                });
            }

            setStyle(style) {
                // Remove all style classes
                document.body.classList.remove('megaman-mode', 'transparent-capture');
                this.widgetContainer.classList.remove('megaman-mode');
                this.chatOverlay.classList.remove('transparent-mode', 'megaman-mode');
                
                // Remove active class from all buttons
                this.solidBtn.classList.remove('active');
                this.transparentBtn.classList.remove('active');
                this.megamanBtn.classList.remove('active');
                this.captureBtn.classList.remove('active');
                
                // Apply new style
                switch(style) {
                    case 'transparent':
                        this.chatOverlay.classList.add('transparent-mode');
                        this.transparentBtn.classList.add('active');
                        break;
                    case 'megaman':
                        document.body.classList.add('megaman-mode');
                        this.widgetContainer.classList.add('megaman-mode');
                        this.chatOverlay.classList.add('megaman-mode');
                        this.megamanBtn.classList.add('active');
                        break;
                    case 'capture':
                        document.body.classList.add('transparent-capture');
                        this.chatOverlay.classList.add('transparent-mode');
                        this.captureBtn.classList.add('active');
                        break;
                    default: // solid
                        this.solidBtn.classList.add('active');
                        break;
                }
                
                this.currentStyle = style;
                console.log('Style switched to:', style);
            }

            checkBrowserSupport() {
                const isOBS = window.obsstudio !== undefined || 
                             navigator.userAgent.includes('OBS') ||
                             window.location.protocol === 'file:';
                
                if (isOBS) {
                    this.showError('⚠️ OBS Browser Source detected. Speech recognition requires Window Capture mode.');
                    this.startBtn.disabled = true;
                    return false;
                }

                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.showError('Speech recognition not supported. Use Chrome/Edge.');
                    this.startBtn.disabled = true;
                    return false;
                }

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.showError('Microphone access not supported in this browser.');
                    this.startBtn.disabled = true;
                    return false;
                }
                
                return true;
            }

            async startListening() {
                try {
                    // Check if we're in OBS Browser Source
                    const isOBS = window.obsstudio !== undefined || 
                                 navigator.userAgent.includes('OBS') ||
                                 window.location.protocol === 'file:';
                    
                    if (isOBS) {
                        this.showError('OBS detected: Use Window Capture instead of Browser Source for speech recognition');
                        return;
                    }

                    // Request permissions explicitly
                    if (navigator.permissions) {
                        const micPermission = await navigator.permissions.query({name: 'microphone'});
                        if (micPermission.state !== 'granted') {
                            this.showError('Microphone permission required. Please allow microphone access.');
                            return;
                        }
                    }

                    await this.initAudio();
                    this.initSpeechRecognition();
                    this.startStaticGeneration();
                    
                    this.isListening = true;
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.statusIndicator.classList.add('listening');
                    this.hideError();
                    
                    // Remove empty state
                    const emptyState = this.chatOverlay.querySelector('.empty-state');
                    if (emptyState) {
                        emptyState.remove();
                    }
                    
                    this.recognition.start();
                    this.animateVisualizer();
                    
                } catch (error) {
                    console.error('Start listening error:', error);
                    if (error.name === 'NotAllowedError') {
                        this.showError('Microphone access denied. Please allow microphone permissions.');
                    } else if (error.name === 'NotSupportedError') {
                        this.showError('Speech recognition not supported in this environment. Use Chrome/Edge with Window Capture.');
                    } else {
                        this.showError('Mic access failed: ' + error.message);
                    }
                    
                    // Reset button states
                    this.startBtn.disabled = false;
                    this.stopBtn.disabled = true;
                    if (this.statusIndicator) {
                        this.statusIndicator.classList.remove('listening');
                    }
                }
            }

            async initAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                this.microphone = this.audioContext.createMediaStreamSource(stream);
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 64; // Lower for better performance
                this.analyser.smoothingTimeConstant = 0.8;
                
                this.microphone.connect(this.analyser);
                this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
            }

            initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.continuous = true;
                this.recognition.interimResults = true; // Enable interim results for real-time display
                this.recognition.lang = 'en-US';

                let finalTranscript = '';
                let lastChunkTime = Date.now();
                const chunkTimeout = 3000; // 3 seconds of silence to create new message
                const maxChunkLength = 100; // Max characters per message chunk

                this.recognition.onresult = (event) => {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                            
                            // Check if we should chunk the message
                            if (finalTranscript.length > maxChunkLength || 
                                Date.now() - lastChunkTime > chunkTimeout) {
                                
                                // Split at sentence boundaries if possible
                                const sentences = finalTranscript.match(/[^\.!?]+[\.!?]+/g);
                                
                                if (sentences && sentences.length > 1) {
                                    // Send first sentence(s) as a chunk
                                    const firstChunk = sentences.slice(0, Math.ceil(sentences.length / 2)).join('');
                                    this.addMessage(firstChunk.trim());
                                    
                                    // Keep remaining for next chunk
                                    finalTranscript = sentences.slice(Math.ceil(sentences.length / 2)).join('');
                                } else if (finalTranscript.length > maxChunkLength) {
                                    // Split at word boundaries
                                    const words = finalTranscript.split(' ');
                                    const midPoint = Math.ceil(words.length / 2);
                                    const firstChunk = words.slice(0, midPoint).join(' ');
                                    
                                    this.addMessage(firstChunk.trim());
                                    finalTranscript = words.slice(midPoint).join(' ');
                                } else {
                                    this.addMessage(finalTranscript.trim());
                                    finalTranscript = '';
                                }
                                
                                lastChunkTime = Date.now();
                            }
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Show interim results for immediate feedback
                    const fullInterimText = finalTranscript + interimTranscript;
                    if (fullInterimText.trim()) {
                        this.updateInterimMessage(fullInterimText);
                    } else {
                        // Clear interim message if no text
                        this.updateInterimMessage('');
                    }
                };

                // Send any remaining text when recognition stops
                this.recognition.onend = () => {
                    if (finalTranscript.trim()) {
                        this.addMessage(finalTranscript.trim());
                        finalTranscript = '';
                    }
                    
                    if (this.isListening) {
                        setTimeout(() => {
                            if (this.isListening) {
                                try {
                                    this.recognition.start();
                                } catch (e) {
                                    console.warn('Recognition restart failed:', e);
                                }
                            }
                        }, 100);
                    }
                };

                this.recognition.onerror = (event) => {
                    if (event.error !== 'no-speech' && event.error !== 'aborted') {
                        console.warn('Speech error:', event.error);
                    }
                };
            }

            startStaticGeneration() {
                const bufferSize = this.audioContext.sampleRate;
                const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                const output = buffer.getChannelData(0);

                // Generate filtered white noise for less CPU usage
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = (Math.random() * 2 - 1) * 0.3;
                }

                this.staticSource = this.audioContext.createBufferSource();
                this.staticSource.buffer = buffer;
                this.staticSource.loop = true;

                const gainNode = this.audioContext.createGain();
                gainNode.gain.setValueAtTime(0.05, this.audioContext.currentTime); // Lower volume

                const filter = this.audioContext.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.setValueAtTime(1000, this.audioContext.currentTime);
                filter.Q.setValueAtTime(3, this.audioContext.currentTime);

                this.staticSource.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                this.staticSource.start();
            }

            animateVisualizer() {
                if (!this.isListening) return;

                const now = Date.now();
                if (now - this.lastAnimationTime >= this.animationInterval) {
                    this.analyser.getByteFrequencyData(this.dataArray);

                    this.bars.forEach((bar, index) => {
                        const value = this.dataArray[index] || 0;
                        const height = Math.max(8, (value / 255) * 50);
                        bar.style.height = height + 'px';
                    });

                    this.lastAnimationTime = now;
                }

                this.animationFrame = requestAnimationFrame(() => this.animateVisualizer());
            }

            stopListening() {
                this.isListening = false;
                
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }
                
                if (this.recognition) {
                    this.recognition.stop();
                }
                
                if (this.staticSource) {
                    this.staticSource.stop();
                    this.staticSource = null;
                }
                
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }

                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.statusIndicator.classList.remove('listening');

                this.bars.forEach(bar => {
                    bar.style.height = '8px';
                });
            }

            addMessage(text) {
                if (!text || text.length === 0) return;

                // Remove any interim message first since we're adding a final message
                const existingInterim = this.chatOverlay.querySelector('.interim-message');
                if (existingInterim) {
                    existingInterim.remove();
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                
                const timestamp = new Date().toLocaleTimeString();
                messageDiv.innerHTML = `
                    <div class="timestamp">${timestamp}</div>
                    <div class="message-text">${this.escapeHtml(text)}</div>
                `;

                this.chatOverlay.appendChild(messageDiv);
                this.chatOverlay.scrollTop = this.chatOverlay.scrollHeight;
                this.messageQueue.push(messageDiv);

                // Auto-remove old messages for performance
                if (this.messageQueue.length > this.maxMessages) {
                    const oldMessage = this.messageQueue.shift();
                    oldMessage.classList.add('fade-out');
                    setTimeout(() => {
                        if (oldMessage.parentNode) {
                            oldMessage.parentNode.removeChild(oldMessage);
                        }
                    }, 2000);
                }

                // Auto-fade after 30 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.classList.add('fade-out');
                        setTimeout(() => {
                            if (messageDiv.parentNode) {
                                messageDiv.parentNode.removeChild(messageDiv);
                                const index = this.messageQueue.indexOf(messageDiv);
                                if (index > -1) {
                                    this.messageQueue.splice(index, 1);
                                }
                            }
                        }, 2000);
                    }
                }, 2000);
            }

            updateInterimMessage(text) {
                if (!text || text.length === 0) {
                    // Remove interim message if no text
                    const existingInterim = this.chatOverlay.querySelector('.interim-message');
                    if (existingInterim) {
                        existingInterim.remove();
                    }
                    return;
                }

                // Check if we already have an interim message
                let interimDiv = this.chatOverlay.querySelector('.interim-message');
                
                if (interimDiv) {
                    // Update existing interim message instead of creating new one
                    const messageText = interimDiv.querySelector('.message-text');
                    if (messageText) {
                        messageText.innerHTML = this.escapeHtml(text) + '...';
                    }
                } else {
                    // Create new interim message only if none exists
                    interimDiv = document.createElement('div');
                    interimDiv.className = 'chat-message interim-message';
                    interimDiv.innerHTML = `
                        <div class="timestamp">Now</div>
                        <div class="message-text">${this.escapeHtml(text)}...</div>
                    `;
                    this.chatOverlay.appendChild(interimDiv);
                }
                
                this.chatOverlay.scrollTop = this.chatOverlay.scrollHeight;
            }

            cleanupOldMessages() {
                this.messageQueue = this.messageQueue.filter(msg => {
                    return msg.parentNode !== null;
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showError(message) {
                this.error.textContent = message;
                this.error.style.display = 'block';
                setTimeout(() => this.hideError(), 5000);
            }

            hideError() {
                this.error.style.display = 'none';
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new OBSVoiceWidget();
        });

        // Prevent context menu for cleaner OBS experience
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>
